{% extends "base.html" %}
{% block title %}Produto{% endblock %}

{# ajusta a variáveis conforme novo ou edit #}
{% set id = result[0].id_produto if result else '0' %}
{% set nome = result[0].nome if result else '' %}
{% set descricao = result[0].descricao if result else '' %}
{% set valor = result[0].valor if result else '' %}
{% set foto = result[0].foto if result else '' %}

{% block content %}
<div class="container mt-5">
    <h1>Produto</h1>
    <form name="{{ 'formEditar' if result else 'formAdicionar' }}"
        id="{{ 'formEditar' if result else 'formAdicionar' }}"
        action="{{ url_for('produto.edit') if result else url_for('produto.insert') }}" method="POST" class="mt-3"
        enctype="multipart/form-data">
        <div class="mb-3">
            <label for="id" class="form-label">Código</label>
            <input type="text" class="form-control" name="id" id="id" value="{{id}}" placeholder="Código" readonly>
        </div>
        <div class="mb-3">
            <label for="nome" class="form-label">Nome do Produto</label>
            <input type="text" class="form-control" name="nome" id="nome" value="{{nome}}" placeholder="Nome do Produto"
                maxlength="100" autofocus required>
        </div>
        <div class="mb-3">
            <label for="descricao" class="form-label">Descrição</label>
            <input type="text" class="form-control" name="descricao" id="descricao" value="{{descricao}}"
                placeholder="Descrição" maxlength="100" required>
        </div>
        <div class="mb-3">
            <label for="valor" class="form-label">Valor</label>
            <input type="text" class="form-control" name="valor" id="valor" value="{{valor}}"
                placeholder="Valor" maxlength="15" required>
        </div>
        <div class="mb-3">
            <label for="foto" class="form-label">Imagem</label>
            <input type="file" class="form-control" name="foto" value="{{foto}}" id="foto" required>
        </div>
        <button type="submit" name="salvaProdutoDB" id="salvaProdutoDB" class="btn btn-primary w-100">
            <i class='fas fa-save'></i> Salvar
        </button>
    </form>
</div>
{% endblock %}

{% block js %}
<script>
    $SCRIPT_ROOT = {{ request.script_root | tojson | safe }}; // pega a url da barra de endereço

    // JS-Ajax para adicionar
    $('#formAdicionar').submit(function (e) {
        e.preventDefault(); // parar o envio para poder fazer manualmente
        var form = $('#formAdicionar')[0]; // captura o form
        var data = new FormData(form); // cria o FormData {Object}

        $.ajax({
            type: "POST",
            enctype: 'multipart/form-data',
            url: "{{url_for('produto.insert')}}",
            data: data,
            processData: false, // impedir que o jQuery transforme a "data" em querystring
            contentType: false, // desabilitar o cabeçalho "Content-Type"
            cache: false, // desabilitar o "cache"
            timeout: 600000, // definir um tempo limite (opcional)

            // manipular o retorno da requisição
            success: function (data) {
                if (!data.erro) {
                    Swal.fire({
                        title: '',
                        text: 'ID' + data.msg.id + ', ' + data.msg.msg,
                        icon: 'success',
                        showCancelButton: false,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'OK'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.replace($SCRIPT_ROOT + "{{ url_for('produto.formListaProduto') }}");
                        }
                    });
                } else {
                    Swal.fire(data.msgErro.msg, data.msgErro.erro, "error");
                }
            },

            // manipular erros da requisição
            error: function (e) {
                console.log(e);
            }
        }); // fim execução ajax
    }); // fim função evento submit

    // incluir aqui a opção para editar
    // Ajax para editar

    // JS-Ajax para editar
    $('#formEditar').submit(function (e) {
        e.preventDefault(); // parar o envio para poder fazer manualmente
        var form = $('#formEditar')[0]; // captura o form
        var data = new FormData(form); // cria o FormData {Object}

        // caso queira adicionar campos extras ao FormData
        // data.append("customfield", "Este é um campo extra para teste");

        $.ajax({
            type: "POST",
            enctype: 'multipart/form-data',
            url: "{{url_for('produto.edit')}}",
            data: data,
            processData: false, // impedir que o jQuery transforme a "data" em querystring
            contentType: false, // desabilitar o cabeçalho "Content-Type"
            cache: false, // desabilitar o "cache"
            timeout: 600000, // definir um tempo limite (opcional)

            // manipular o retorno da requisição
            success: function (data) {
                if (!data.erro) {
                    Swal.fire({
                        title: '',
                        text: 'ID' + data.msg.id + ', ' + data.msg.msg,
                        icon: 'success',
                        showCancelButton: false,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'OK'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.replace($SCRIPT_ROOT + "{{ url_for('produto.formListaProduto') }}");
                        }
                    });
                } else {
                    Swal.fire(data.msgErro.msg, data.msgErro.erro, "error");
                }
            },

            // manipular erros da requisição
            error: function (e) {
                console.log(e);
            }
        }); // fim execução ajax
    }); // fim função evento submit

</script>
{% endblock %}